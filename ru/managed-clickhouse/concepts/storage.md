# Типы дисков в {{ mch-name }}


{{ mch-name }} позволяет использовать сетевые и локальные диски для организации хранилища кластеров баз данных. Сетевые диски реализованы на базе сетевых блоков — виртуальных дисков в инфраструктуре {{ yandex-cloud }}. Локальные диски физически размещаются в серверах хостов БД.

{% include [storage-type](../../_includes/mdb/mch/storage-type.md) %}

## Особенности гибридного хранилища {#hybrid-storage-features}

Если при создании или изменении кластера включить настройку **{{ ui-key.yacloud.mdb.forms.additional-field-cloud-storage }}**, появится возможность распределять данные между хранилищем кластера и объектным хранилищем [{{ objstorage-full-name }}](../../storage/). Тогда данные будут размещаться либо в кластерном, либо в объектном хранилище в зависимости от заданной политики хранения. Например, часто используемые <q>горячие</q> данные размещаются в хранилище кластера, а редко используемые <q>холодные</q> данные — в более дешевом и медленном объектном хранилище.

{% note warning %}

Гибридное хранилище доступно для таблиц только на [движке MergeTree]({{ ch.docs }}/engines/table-engines/mergetree-family/mergetree/). Данные таблиц на других движках хранятся только в кластерном хранилище.

{% endnote %}

В объектном хранилище используется служебный бакет с неограниченным объемом памяти. [Класс такого хранилища](../../storage/concepts/storage-class.md) — стандартный, изменить его нельзя. Для объектного хранилища применяются [лимиты сервиса {{ objstorage-name }}](../../storage/concepts/limits.md).

Чтобы начать использовать гибридное хранилище:

1. Создайте кластер нужного вида с версией {{ CH }} не ниже {{ mch-ck-version }}. Настройка объектного хранилища не требуется.

1. Добавьте базы данных и таблицы в кластер. Если политика хранения по умолчанию не подходит для некоторых таблиц, задайте нужные политики для этих таблиц:

    * Чтобы указать политику при создании таблицы, задайте настройку `storage_policy`:

        ```sql
        CREATE TABLE table_with_non_default_policy (
            <схема_таблицы>
        ) ENGINE = MergeTree
        ...
        SETTINGS storage_policy = '<тип_политики_хранения>';
        ```

    * Чтобы задать или изменить политику для уже существующей таблицы, используйте запрос:

        ```sql
        ALTER TABLE table_with_non_default_policy
        MODIFY SETTING storage_policy = '<тип_политики_хранения>';
        ```

Пример см. в практическом руководстве [Использование гибридного хранилища](../tutorials/hybrid-storage.md).

Чтобы отслеживать, какой объем занимают куски таблиц [MergeTree]({{ ch.docs }}/engines/table-engines/mergetree-family/mergetree/) в {{ objstorage-full-name }}, [воспользуйтесь метрикой](../tutorials/hybrid-storage.md#metrics) `ch_s3_disk_parts_size` в сервисе {{ monitoring-full-name }}. Она доступна только для кластеров {{ mch-name }} с настроенным гибридным хранилищем.

### Доступные политики хранения {#storage-policies}

{% note info %}

Создавать новые политики хранения или изменять уже существующие нельзя.

{% endnote %}

В кластере {{ mch-name }} с включенным гибридным хранилищем предустановлены следующие политики хранения:

* `default` (по умолчанию) — кластер автоматически управляет размещением данных в зависимости от:

    * [настроек гибридного хранилища](#hybrid-storage-settings);
    * настроек [TTL]({{ ch.docs }}/engines/table-engines/mergetree-family/mergetree/#mergetree-table-ttl) для таблиц (время жизни).

    При достаточном объеме свободного места в кластерном хранилище, перемещение в объектное хранилище выполняется только для тех строк таблицы, для которых истекло значение TTL. Эта операция позволяет переместить часть данных в объектное хранилище, не дожидаясь заполнения кластерного хранилища.

    Настроить перемещение строк с истекшим сроком жизни в объектное хранилище и задать значение TTL можно при создании таблицы или позднее.

* `local` — строки таблицы с такой политикой размещаются только в кластерном хранилище. Перемещения данных между хранилищами не происходит.

* `object_storage` — строки таблицы с такой политикой размещаются только в объектном хранилище. Перемещения данных между хранилищами не происходит.

Политики хранения не оказывают влияния на [операции слияния]({{ ch.docs }}/engines/table-engines/mergetree-family/custom-partitioning-key/) кусков данных. При любой политике хранения вы можете:

* Включать и выключать настройку `prefer_not_to_merge`, которая выполняет слияние кусков данных в хранилищах. Настройка доступна в [CLI и API](../operations/update.md#change-hybrid-storage).
* Задавать любое значение настройке `max_data_part_size_bytes`, которая устанавливает максимальный размер итогового куска данных после слияния меньших кусков.

Однако можно влиять на поведение этих операций с помощью доступных в кластере [настроек ClickHouse](./settings-list.md).

Посмотреть актуальные настройки политик можно с помощью запроса:

```sql
SELECT *
FROM system.storage_policies;
```

Подробнее о политиках хранения и их настройках см. в [документации {{ CH }}]({{ ch.docs }}/engines/table-engines/mergetree-family/mergetree/#table_engine-mergetree-multiple-volumes).

### Настройки гибридного хранилища {#hybrid-storage-settings}

В кластере {{ mch-name }} с включенным гибридным хранилищем доступны следующие настройки:

* `data_cache_enabled` — разрешает временное хранение в кластерном хранилище данных, запрошенных из объектного хранилища. По умолчанию — `true` (разрешено).

    При таком подходе запрашиваемые из объектного хранилища <q>холодные</q> данные попадают на быстрые диски, где их обработка будет занимать меньше времени.

* `data_cache_max_size` — определяет максимальный объем памяти (в байтах), выделяемый в кластерном хранилище для временного хранения данных, запрошенных из объектного хранилища. По умолчанию — `1073741824` (1 ГБ).
* `move_factor`— устанавливает минимальную долю свободного места в кластерном хранилище. Если доля свободного места меньше этого значения, данные переносятся в {{ objstorage-full-name }}. Минимальное значение — `0`, максимальное — `1`, по умолчанию — `0.01`.

    Куски данных для переноса выстраиваются в очередь от большего к меньшему, затем переносится такое количество кусков, при котором будет выполняться условие `move_factor`.

* `prefer_not_to_merge` — отключает [слияние кусков данных]({{ ch.docs }}/engines/table-engines/mergetree-family/custom-partitioning-key/) в кластерном и объектном хранилищах. По умолчанию слияние включено.

    После вставки данных в таблицу они сохраняются в виде куска данных и сортируются по первичному ключу. Затем в фоновом режиме куски одной партиции сливаются в более крупный кусок через 10–15 минут после вставки. Вы можете использовать системную таблицу [system.parts]({{ ch.docs }}/operations/system-tables/parts#system_tables-parts), чтобы посмотреть слитые куски данных и партиции.

Задать настройки гибридного хранилища можно при [создании](../operations/cluster-create.md) или [изменении](../operations/update.md#change-hybrid-storage) кластера.

Подробнее о настройках гибридного хранилища см. в [документации {{ CH }}](https://clickhouse.com/docs/ru/engines/table-engines/mergetree-family/mergetree/#table_engine-mergetree-multiple-volumes).


## Выбор типа дисков при создании кластера {#storage-type-selection}

Количество хостов, которые можно создать вместе с {{ CH }}-кластером, зависит от выбранного типа дисков:

* При использовании локальных SSD-дисков (`local-ssd`) вы можете создать кластер из двух или более хостов.

    Такой кластер будет отказоустойчивым.

    Хранилище на локальных SSD-дисках влияет на тарификацию кластера: он тарифицируется, даже если остановлен. Подробнее в [правилах тарификации](../pricing.md).

* При использовании сетевых нереплицируемых SSD-дисков (`network-ssd-nonreplicated`) вы можете создать кластер из трех или более хостов.

    Такой кластер будет отказоустойчивым.

* При использовании сетевых HDD-дисков (`network-hdd`) или сетевых SSD-дисков (`network-ssd`) вы можете добавить любое количество хостов в пределах текущей квоты.

Подробнее об ограничениях на количество хостов в кластере см. в разделе [Квоты и лимиты](./limits.md).


